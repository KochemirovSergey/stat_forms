# Схема работы модуля обработки запросов к статистическим данным

```mermaid
graph TD
    A[Запрос пользователя] --> B[Загрузка списка таблиц]
    B --> C[LLM: Выбор таблицы]
    C -->|table_number + table_name| D[Чтение схемы из CSV файла]
    C -->|НЕТ ПОДХОДЯЩЕЙ ТАБЛИЦЫ| E[Ошибка]
    
    D --> F[LLM: Поиск ячеек]
    F -->|JSON с координатами ячеек| G[Извлечение данных 2021-2024]
    F -->|НЕ УДАЛОСЬ НАЙТИ ЯЧЕЙКИ| E
    
    G --> H[Сохранение в CSV + Вывод результатов]
    
    subgraph LLM1["1-й запрос к LLM"]
        I["ВХОД:<br/>• Запрос пользователя<br/>• Список всех таблиц"]
        J["ВЫХОД:<br/>• table_number: '1.2.3'<br/>• table_name: 'Название'"]
    end
    
    subgraph SCHEMA["Парсинг схемы таблицы"]
        M["ФАЙЛ:<br/>БД/2024/Раздел 1.2.3.csv"]
        N["СХЕМА:<br/>• columns: {номер: название}<br/>• rows: {номер: название}"]
    end
    
    subgraph LLM2["2-й запрос к LLM"]
        K["ВХОД:<br/>• Запрос пользователя<br/>• Схема таблицы<br/>(все колонки и строки)"]
        L["ВЫХОД:<br/>• column_name + column_number<br/>• row_name + row_number<br/>для каждой нужной ячейки"]
    end
    
    C -.-> I
    I -.-> J
    D -.-> M
    M -.-> N
    F -.-> K
    K -.-> L
    
    style A fill:#e1f5fe
    style H fill:#c8e6c9
    style E fill:#ffcdd2
    style I fill:#fff3e0
    style M fill:#e8f5e8
    style K fill:#fff3e0
```

## Этапы обработки запроса

### 1-й запрос к LLM: Выбор подходящей таблицы

**Что передается:**
- Запрос пользователя (например: "Сколько браков в России?")
- Полный список доступных таблиц с номерами (1.1, 1.2.1, 2.3.4 и т.д.)

**Что возвращает:**
```json
{
  "table_number": "1.2.3",
  "table_name": "Браки и разводы по регионам"
}
```

### Парсинг схемы таблицы (table_schema.py)

**Что происходит:**
- Открывается файл `БД/2024/Раздел 1.2.3.csv`
- Пропускаются первые 5 строк
- Из 6-й строки читаются номера колонок
- Из 7-й строки читаются названия колонок
- Начиная с 8-й строки читаются номера и названия строк

**Результат:**
```json
{
  "columns": {"1": "Всего", "2": "2021", "3": "2022", "4": "2023"},
  "rows": {"1": "Российская Федерация", "2": "Москва", "3": "СПб"}
}
```

### 2-й запрос к LLM: Поиск конкретных ячеек

**Что передается:**
- Тот же запрос пользователя
- Полная схема таблицы (все колонки и строки с номерами)

**Что возвращает:**
```json
{
  "cells": [
    {
      "column_name": "2023",
      "column_number": 4,
      "row_name": "Российская Федерация",
      "row_number": 1
    }
  ]
}
```

### Результат работы:

Система извлекает данные из найденных ячеек за 2021-2024 годы и сохраняет в CSV файл в папке `query_log/`.