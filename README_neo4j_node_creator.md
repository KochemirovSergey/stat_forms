# Модуль создания узлов Neo4j из статистических данных

## Описание

Модуль `neo4j_node_creator.py` предназначен для автоматического создания узлов в базе данных Neo4j с массивными статистическими данными, собранными из CSV-файлов за период 2021-2024 годы по всем регионам России.

## Возможности

- ✅ Пакетная обработка множества узлов
- ✅ Автоматический сбор федеральных данных за 2021-2024 годы
- ✅ Автоматический сбор региональных данных по всем регионам
- ✅ Создание связей между узлами
- ✅ Обработка пустых значений (замена на `null`)
- ✅ Детальное логирование процесса
- ✅ Возврат статистики обработки

## Структура данных

### Входная конфигурация

```json
{
  "nodes": [
    {
      "node_name": "Население_городское",
      "node_label": "StatisticNode",
      "table_number": "2.1.1",
      "column": 3,
      "row": 5,
      "relationships": [
        {
          "from_id": "4:2a2ab0e9-9777-41b2-89a4-9d85382603dc:58",
          "type": "ПоКласс"
        }
      ]
    }
  ]
}
```

### Структура создаваемых узлов и связей

**Основной узел:**
```cypher
CREATE (n:StatisticNode {
  name: "Население_городское",
  years: [2021, 2022, 2023, 2024],
  federal_values: [1000, null, 1200, 1300],
  table_number: "2.1.1",
  column: 3,
  row: 5
})
```

**Узлы регионов:**
```cypher
CREATE (r:Region {name: "Москва"})
CREATE (r:Region {name: "Санкт-Петербург"})
// ... для каждого региона
```

**Связи с региональными данными:**
```cypher
CREATE (n)-[:ПоРегион {
  value_2021: null,
  value_2022: 24.0,
  value_2023: 25.0,
  value_2024: 16.0
}]->(r:Region {name: "Москва"})
```

## Установка зависимостей

```bash
pip install -r requirements.txt
```

Основные зависимости:
- `neo4j==5.15.0` - драйвер для работы с Neo4j
- `pandas==2.2.3` - обработка CSV данных
- `numpy==2.2.4` - численные операции

## Конфигурация

### 1. Настройка подключения к Neo4j

Создайте файл `neo4j_config.json`:

```json
{
  "NEO4J_URI": "neo4j+s://your-database-url",
  "NEO4J_USERNAME": "neo4j",
  "NEO4J_PASSWORD": "your-password",
  "NEO4J_DATABASE": "neo4j"
}
```

### 2. Структура файловой системы

Убедитесь, что данные организованы следующим образом:

```
БД/
├── 2021/
│   ├── Раздел 2.1.1.csv          # Федеральные данные
│   └── 2021/                     # Региональные данные
│       ├── Москва/
│       │   └── Раздел 2.1.1.csv
│       ├── Санкт-Петербург/
│       │   └── Раздел 2.1.1.csv
│       └── ...
├── 2022/
├── 2023/
└── 2024/
```

## Использование

### Базовое использование

```python
from neo4j_node_creator import Neo4jNodeCreator

# Создаем экземпляр
creator = Neo4jNodeCreator()

# Обрабатываем пакет узлов
result = creator.process_batch("batch_nodes_config.json")

print(f"Создано узлов: {result['created_nodes']}")
print(f"Создано связей: {result['total_relationships']}")
```

### Создание одного узла

```python
creator = Neo4jNodeCreator()

node_config = {
    "node_name": "Население_городское",
    "node_label": "StatisticNode",
    "table_number": "2.1.1",
    "column": 3,
    "row": 5
}

creator.connect()
node_id = creator.create_node(node_config)
creator.disconnect()

print(f"Создан узел с ID: {node_id}")
```

### Тестирование сбора данных

```python
creator = Neo4jNodeCreator()

# Тест федеральных данных
federal_data = creator.collect_federal_data("2.1.1", 3, 5)
print(f"Федеральные данные: {federal_data}")

# Тест региональных данных
regions, regional_data = creator.collect_regional_data("2.1.1", 3, 5)
print(f"Найдено регионов: {len(regions)}")
```

## Примеры конфигураций

### Простой узел без связей

```json
{
  "nodes": [
    {
      "node_name": "Общая_численность_населения",
      "node_label": "Population",
      "table_number": "2.1.1",
      "column": 2,
      "row": 5
    }
  ]
}
```

### Узел со связями

```json
{
  "nodes": [
    {
      "node_name": "Население_городское",
      "node_label": "Population",
      "table_number": "2.1.1",
      "column": 3,
      "row": 5,
      "relationships": [
        {
          "from_id": "4:2a2ab0e9-9777-41b2-89a4-9d85382603dc:58",
          "type": "ПоКласс"
        },
        {
          "from_id": "4:2a2ab0e9-9777-41b2-89a4-9d85382603dc:60",
          "type": "Включает"
        }
      ]
    }
  ]
}
```

### Множественные узлы

```json
{
  "nodes": [
    {
      "node_name": "Население_городское",
      "node_label": "Population",
      "table_number": "2.1.1",
      "column": 3,
      "row": 5
    },
    {
      "node_name": "Население_сельское",
      "node_label": "Population",
      "table_number": "2.1.1",
      "column": 4,
      "row": 5
    },
    {
      "node_name": "Рождаемость",
      "node_label": "Demographics",
      "table_number": "2.2.1",
      "column": 2,
      "row": 3
    }
  ]
}
```

## Результат обработки

Модуль возвращает детальную статистику обработки:

```json
{
  "success": true,
  "total_nodes": 3,
  "created_nodes": 2,
  "failed_nodes": 1,
  "total_relationships": 2,
  "processing_log": [
    "Обработка узла 1/3: 'Население_городское'",
    "Узел 'Население_городское' создан успешно",
    "Связь 'ПоКласс' создана для узла 'Население_городское'",
    "Ошибка создания узла 'Население_сельское': файл не найден",
    "Обработка завершена: 2/3 узлов создано"
  ],
  "created_node_ids": [
    "4:2a2ab0e9-9777-41b2-89a4-9d85382603dc:59",
    "4:2a2ab0e9-9777-41b2-89a4-9d85382603dc:60"
  ]
}
```

## Тестирование

Запустите тестовый скрипт для проверки работы модуля:

```bash
python test_neo4j_node_creator.py
```

Тесты включают:
- ✅ Проверка подключения к Neo4j
- ✅ Тест сбора федеральных данных
- ✅ Тест сбора региональных данных
- ✅ Создание одного узла
- ✅ Пакетная обработка узлов

## Обработка ошибок

Модуль обрабатывает следующие типы ошибок:

1. **Отсутствие файлов данных** - значения заменяются на `null`
2. **Ошибки подключения к Neo4j** - логируются и прерывают выполнение
3. **Некорректные данные в CSV** - значения заменяются на `null`
4. **Ошибки создания связей** - логируются, но не прерывают обработку

## Особенности реализации

### Сбор данных

- **Годы**: Фиксированный период 2021-2024
- **Регионы**: Порядок как в файловой системе (порядок обнаружения папок)
- **Пустые значения**: Заменяются на `null` в массивах
- **Числовые значения**: Автоматическое преобразование с заменой запятых на точки

### Создание узлов

- **ID узлов**: Автоматически генерируются Neo4j
- **Связи**: Всегда исходящие от указанного `from_id` к создаваемому узлу
- **Свойства**: Включают исходные координаты данных (таблица, колонка, строка)

### Производительность

- Пакетная обработка множества узлов за один запуск
- Переиспользование подключения к Neo4j
- Детальное логирование для отслеживания прогресса

## Структура проекта

```
├── neo4j_node_creator.py          # Основной модуль
├── test_neo4j_node_creator.py     # Тестовый скрипт
├── neo4j_config.json              # Конфигурация подключения
├── batch_nodes_config.json        # Пример конфигурации узлов
├── excel_reader.py                # Модуль чтения федеральных данных
├── region_visualizer.py           # Модуль работы с региональными данными
└── requirements.txt               # Зависимости
```

## Лицензия

Модуль разработан для внутреннего использования в проекте статистической обработки данных.

---

**Версия**: 1.0.0  
**Автор**: Neo4j Node Creator  
**Дата**: 2025